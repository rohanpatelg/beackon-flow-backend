import { RequestHandler } from 'express';
import { linkedinService } from '@/services/linkedinService';
import jwt from 'jsonwebtoken';

/**
 * Initiate LinkedIn OAuth flow
 * POST /api/linkedin/auth/initiate
 */
export const initiateAuth: RequestHandler = async (req, res) => {
  try {
    const userId = req.user?.id; // Optional: if user is already logged in
    const { returnUrl } = req.body;

    const { authUrl, state } = await linkedinService.initiateOAuth(userId, returnUrl);

    res.status(200).json({
      success: true,
      data: {
        authUrl,
        state,
      },
    });
  } catch (error) {
    console.error('LinkedIn auth initiation error:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to initiate LinkedIn authentication',
    });
  }
};

/**
 * Handle LinkedIn OAuth callback
 * GET /api/linkedin/auth/callback?code=...&state=...
 */
export const handleCallback: RequestHandler = async (req, res) => {
  try {
    const { code, state } = req.query;

    if (!code || !state) {
      res.status(400).json({
        success: false,
        message: 'Missing authorization code or state parameter',
      });
      return;
    } 

    // Exchange code for token
    const tokenData = await linkedinService.exchangeCodeForToken(
      code as string,
      state as string
    );

    // Get user profile from LinkedIn
    const profile = await linkedinService.getUserProfile(tokenData.access_token);

    // Find or create user 
    const { pool } = await import('@/config/database');

    // Check if user exists with this LinkedIn ID
    let userResult = await pool.query(
      `SELECT * FROM m_users WHERE linkedin_id = $1`,
      [profile.sub]
    );

    let user;

    if (userResult.rows.length === 0) {
      // Check if user exists with this email
      userResult = await pool.query(
        `SELECT * FROM m_users WHERE email = $1`,
        [profile.email]
      );

      if (userResult.rows.length > 0) {
        // User exists with email, link LinkedIn account
        user = userResult.rows[0];
      } else {
        // Create new user
        const newUserResult = await pool.query(
          `INSERT INTO m_users (username, email, password_hash, linkedin_id, is_email_verified, is_active)
           VALUES ($1, $2, $3, $4, $5, $6)
           RETURNING *`,
          [
            profile.email.split('@')[0], // Use email prefix as username
            profile.email,
            '', // No password for OAuth users
            profile.sub,
            true, // Email verified via LinkedIn
            true,
          ]
        );

        user = newUserResult.rows[0];

        // Assign default 'user' role
        await pool.query(
          `INSERT INTO m_user_roles (user_id, role_id)
           SELECT $1, id FROM m_roles WHERE role_name = 'user'`,
          [user.id]
        );
      }
    } else {
      user = userResult.rows[0];
    }

    // Store LinkedIn token
    await linkedinService.storeToken(user.id, tokenData, profile);

    // Generate JWT for app authentication
    const jwtSecret = process.env.JWT_SECRET;
    if (!jwtSecret) {
      throw new Error('JWT_SECRET not configured');
    }

    const jwtToken = jwt.sign(
      {
        id: user.id,
        email: user.email,
        linkedin_id: profile.sub,
      },
      jwtSecret,
      { expiresIn: '30d' }
    );

    // Encode user data for deep link
    const userData = JSON.stringify({
      id: user.id,
      email: user.email,
      name: profile.name,
      picture: profile.picture,
      linkedin_id: profile.sub,
    });

    // Deep link back to mobile app
    const deepLinkUrl = `beaconflow://auth-success?jwt=${encodeURIComponent(jwtToken)}&user=${encodeURIComponent(userData)}`;

    // Show success page with redirect button
    res.send(`
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>LinkedIn Authentication Successful</title>
          <style>
            body {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
              display: flex;
              align-items: center;
              justify-content: center;
              min-height: 100vh;
              margin: 0;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
            .container {
              background: white;
              padding: 2rem;
              border-radius: 12px;
              box-shadow: 0 10px 40px rgba(0,0,0,0.1);
              text-align: center;
              max-width: 400px;
            }
            .success-icon {
              width: 80px;
              height: 80px;
              background: #10b981;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              margin: 0 auto 1.5rem;
            }
            .success-icon::after {
              content: '✓';
              color: white;
              font-size: 48px;
              font-weight: bold;
            }
            h1 {
              color: #1a202c;
              margin-bottom: 0.5rem;
              font-size: 1.5rem;
            }
            p {
              color: #718096;
              margin-bottom: 2rem;
            }
            .button {
              display: inline-block;
              background: #0077b5;
              color: white;
              padding: 12px 32px;
              border-radius: 6px;
              text-decoration: none;
              font-weight: 600;
              transition: background 0.2s;
            }
            .button:hover {
              background: #005582;
            }
          </style>
          <script>
            // Auto-redirect after 2 seconds
            setTimeout(() => {
              window.location.href = '${deepLinkUrl}';
            }, 2000);
          </script>
        </head>
        <body>
          <div class="container">
            <div class="success-icon"></div>
            <h1>Authentication Successful!</h1>
            <p>Your LinkedIn account has been connected successfully. Redirecting you back to the app...</p>
            <a href="${deepLinkUrl}" class="button">Return to Beacon Flow</a>
          </div>
        </body>
      </html>
    `);
  } catch (error) {
    console.error('LinkedIn callback error:', error);

    res.status(500).send(`
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="UTF-8">
          <meta name="viewport"="width=device-width, initial-scale=1.0">
          <title>Authentication Failed</title>
          <style>
            body {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
              display: flex;
              align-items: center;
              justify-content: center;
              min-height: 100vh;
              margin: 0;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
            .container {
              background: white;
              padding: 2rem;
              border-radius: 12px;
              box-shadow: 0 10px 40px rgba(0,0,0,0.1);
              text-align: center;
              max-width: 400px;
            }
            .error-icon {
              width: 80px;
              height: 80px;
              background: #ef4444;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              margin: 0 auto 1.5rem;
            }
            .error-icon::after {
              content: '✕';
              color: white;
              font-size: 48px;
              font-weight: bold;
            }
            h1 {
              color: #1a202c;
              margin-bottom: 0.5rem;
              font-size: 1.5rem;
            }
            p {
              color: #718096;
            }
          </style>
        </head>
        <body>
          <div class="container">
            <div class="error-icon"></div>
            <h1>Authentication Failed</h1>
            <p>${error instanceof Error ? error.message : 'An unexpected error occurred'}</p>
            <p>Please try again or contact support if the problem persists.</p>
          </div>
        </body>
      </html>
    `);
  }
};

/**
 * Get LinkedIn authentication status
 * GET /api/linkedin/auth/status
 */
export const getAuthStatus: RequestHandler = async (req, res) => {
  try {
    const userId = req.user?.id;

    if (!userId) {
      res.status(401).json({
        success: false,
        message: 'Authentication required',
      });
      return;
    }

    const token = await linkedinService.getToken(userId);
    const isValid = await linkedinService.isTokenValid(userId);

    if (!token) {
      res.status(200).json({
        success: true,
        data: {
          authenticated: false,
          profile: null,
        },
      });
      return;
    }

    res.status(200).json({
      success: true,
      data: {
        authenticated: isValid,
        profile: {
          linkedin_id: token.linkedin_id,
          name: token.linkedin_name,
          email: token.linkedin_email,
          picture: token.linkedin_picture,
        },
        expires_at: token.expires_at,
      },
    });
  } catch (error) {
    console.error('LinkedIn status check error:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to check LinkedIn authentication status',
    });
  }
};

/**
 * Publish a post to LinkedIn
 * POST /api/linkedin/publish
 */
export const publishPost: RequestHandler = async (req, res) => {
  try {
    const userId = req.user?.id;

    if (!userId) {
      res.status(401).json({
        success: false,
        message: 'Authentication required',
      });
      return;
    }

    const { post_text } = req.body;

    if (!post_text) {
      res.status(400).json({
        success: false,
        message: 'Post content is required',
      });
      return;
    }

    // Get user's LinkedIn token
    const token = await linkedinService.getToken(userId);

    if (!token) {
      res.status(400).json({
        success: false,
        message: 'LinkedIn account not connected',
      });
      return;
    }

    // Check if token is still valid
    const isValid = await linkedinService.isTokenValid(userId);
    if (!isValid) {
      res.status(401).json({
        success: false,
        message: 'LinkedIn token expired. Please re-authenticate.',
      });
      return;
    }

    // Publish the post
    const result = await linkedinService.publishPost(
      token.access_token,
      token.linkedin_id,
      post_text
    );

    res.status(200).json({
      success: true,
      data: {
        message: 'Post published successfully',
        postId: result.id,
      },
    });
  } catch (error) {
    console.error('LinkedIn publish error:', error);

    if (error instanceof Error && error.message.includes('expired')) {
      res.status(401).json({
        success: false,
        message: error.message,
      });
      return;
    }

    res.status(500).json({
      success: false,
      message: error instanceof Error ? error.message : 'Failed to publish post',
    });
  }
};

/**
 * Disconnect LinkedIn account
 * DELETE /api/linkedin/auth/disconnect
 */
export const disconnectLinkedIn: RequestHandler = async (req, res) => {
  try {
    const userId = req.user?.id;

    if (!userId) {
      res.status(401).json({
        success: false,
        message: 'Authentication required',
      });
      return;
    }

    await linkedinService.revokeToken(userId);

    res.status(200).json({
      success: true,
      message: 'LinkedIn account disconnected successfully',
    });
  } catch (error) {
    console.error('LinkedIn disconnect error:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to disconnect LinkedIn account',
    });
  }
};
